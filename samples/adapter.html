<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gastown Dashboard</title>
<link rel="stylesheet" href="/shared/styles.css">
<style>
  /* Adapter-specific styles */
  .output-wrap {
    flex: 1;
    overflow: hidden;
    position: relative;
  }

  @media (max-width: 520px) {
    .tree-row { padding: 4px 6px; }
    .tree-view { font-size: 11px; }
  }
</style>
<script type="importmap">
{ "imports": { "ghostty-web": "https://cdn.jsdelivr.net/npm/ghostty-web/+esm" } }
</script>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <div class="sidebar-header">
      <button type="button" class="sidebar-close" id="sidebar-close" aria-label="Close drawer">×</button>
      <span class="sidebar-title">tmux</span>
    </div>
    <div class="tree-view" id="tree-view">
      <div class="agent-list-state"><span class="spinner"></span><span>Loading...</span></div>
    </div>
  </div>

  <div class="main">
    <div class="main-header" id="main-header">
      <button type="button" class="mobile-nav-btn" id="mobile-nav-btn" aria-label="Open drawer">☰</button>
      <div class="header-content" id="header-content">Select a pane to view</div>
      <button type="button" id="kb-toggle" style="display:none; background:rgba(22,27,34,0.9); border:1px solid #30363d; border-radius:6px; color:#8b949e; font-size:18px; width:36px; height:36px; cursor:pointer; align-items:center; justify-content:center; -webkit-tap-highlight-color:transparent" aria-label="Toggle keyboard">&#x2328;</button>
      <div class="connection-status" id="connection-status">
        <span class="dot disconnected" id="status-dot"></span>
        <span id="status-text">Connecting...</span>
      </div>
    </div>
    <div class="output-wrap" id="output-wrap">
      <div class="placeholder" id="placeholder">Select a pane from the sidebar</div>
    </div>
  </div>
</div>
<div class="drawer-backdrop" id="drawer-backdrop"></div>

<script type="module">
import { init } from 'ghostty-web';
import { clearChildren, isMobileLayout, openDrawer, closeDrawer } from '/shared/utils.js';
await init();

var adapterHost = new URLSearchParams(location.search).get('adapter') || location.host || 'localhost:8080';
var adapterOrigin = (location.protocol === 'https:' ? 'https://' : 'http://') + adapterHost;

// Remote debug logging
function rlog() {
  var msg = Array.prototype.slice.call(arguments).join(' ');
  console.log('[rlog]', msg);
  navigator.sendBeacon(adapterOrigin + '/debug/log', msg);
}
window.rlog = rlog;

var cacheBust = '?v=' + Date.now();
var { decodeBinaryFrame, encodeBinaryFrame, BinaryMsgType } = await import(adapterOrigin + '/tmux-adapter-web/index.js' + cacheBust);

// --- State ---
var selectedTarget = null;    // tmux target of currently selected pane (e.g., "session:0.1")
var treeData = [];            // array of TmuxSessionNode
var expandedNodes = new Set(); // set of node IDs that are expanded
var msgId = 0;
var ws = null;
var textEncoder = new TextEncoder();
var treeLoading = true;
var treeLoadTimedOut = false;
var treeLoadTimer = null;
var TreeLoadTimeoutMs = 7000;
var treeRefreshInterval = null;
var TreeRefreshMs = 5000;

// --- DOM refs ---
var treeViewEl       = document.getElementById('tree-view');
var outputWrapEl     = document.getElementById('output-wrap');
var headerContentEl  = document.getElementById('header-content');
var placeholderEl    = document.getElementById('placeholder');
var statusDot        = document.getElementById('status-dot');
var statusText       = document.getElementById('status-text');
var mobileNavBtn     = document.getElementById('mobile-nav-btn');
var sidebarCloseBtn  = document.getElementById('sidebar-close');
var drawerBackdropEl = document.getElementById('drawer-backdrop');
var kbToggleBtn      = document.getElementById('kb-toggle');
var kbActive = false;

// --- Mobile keyboard toggle ---
var isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
var kbFocusGuardUntil = 0;
if (isTouchDevice) {
  kbToggleBtn.style.display = 'flex';
  kbToggleBtn.addEventListener('touchend', function(ev) {
    ev.preventDefault();
    ev.stopPropagation();
    kbActive = !kbActive;
    var el = selectedTarget ? outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(selectedTarget) + '"]') : null;
    if (kbActive && el) {
      kbFocusGuardUntil = Date.now() + 500;
      el.focusTextarea();
      setTimeout(function() { if (kbActive && el) el.focusTextarea(); }, 300);
      kbToggleBtn.style.color = '#58a6ff';
      kbToggleBtn.style.borderColor = '#58a6ff';
    } else if (!kbActive && el) {
      el.blurTextarea();
      kbToggleBtn.style.color = '#8b949e';
      kbToggleBtn.style.borderColor = '#30363d';
    }
  });

  outputWrapEl.addEventListener('focusout', function(ev) {
    if (kbActive && ev.target && ev.target.tagName === 'TEXTAREA') {
      if (Date.now() < kbFocusGuardUntil) return;
      kbActive = false;
      kbToggleBtn.style.color = '#8b949e';
      kbToggleBtn.style.borderColor = '#30363d';
    }
  });
}

// --- Terminal event wiring ---
outputWrapEl.addEventListener('terminal-input', function(e) {
  sendBinary(BinaryMsgType.KeyboardInput, e.detail.name, e.detail.data);
});

outputWrapEl.addEventListener('terminal-resize', function(e) {
  sendBinary(BinaryMsgType.Resize, e.detail.name, textEncoder.encode(e.detail.cols + ':' + e.detail.rows));
});

outputWrapEl.addEventListener('file-upload', function(e) {
  sendBinary(BinaryMsgType.FileUpload, e.detail.name, e.detail.payload);
});

// --- Helpers ---
function clearTreeLoadTimer() {
  if (!treeLoadTimer) return;
  clearTimeout(treeLoadTimer);
  treeLoadTimer = null;
}

function startTreeLoading() {
  treeLoading = true;
  treeLoadTimedOut = false;
  clearTreeLoadTimer();
  treeLoadTimer = setTimeout(function() {
    if (!treeLoading) return;
    treeLoading = false;
    treeLoadTimedOut = true;
    renderTree();
  }, TreeLoadTimeoutMs);
  renderTree();
}

function markTreeLoaded() {
  treeLoading = false;
  treeLoadTimedOut = false;
  clearTreeLoadTimer();
}

function sendResizeNow(target) {
  var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(target) + '"]');
  if (!el || !el.cols || !el.rows) return false;
  sendBinary(BinaryMsgType.Resize, target, textEncoder.encode(el.cols + ':' + el.rows));
  return true;
}

function subscribeOutputWithSizedSnapshot(target) {
  if (!target) return;
  requestAnimationFrame(function() {
    sendResizeNow(target);
    send({ type: 'subscribe-output', agent: target });
  });
}

function syncMobileNavButton() {
  if (!mobileNavBtn) return;
  mobileNavBtn.textContent = '\u2630';
  mobileNavBtn.setAttribute('aria-label', 'Open drawer');
}

function bindMobileLayoutEvents() {
  if (mobileNavBtn) {
    mobileNavBtn.addEventListener('click', function() {
      if (!isMobileLayout()) return;
      openDrawer();
    });
  }
  if (sidebarCloseBtn) {
    sidebarCloseBtn.addEventListener('click', function() { closeDrawer(); });
  }
  if (drawerBackdropEl) {
    drawerBackdropEl.addEventListener('click', function() { closeDrawer(); });
  }

  var media = window.matchMedia('(max-width: 900px)');
  var onChange = function(ev) {
    if (!ev.matches) {
      closeDrawer();
    } else if (!selectedTarget) {
      openDrawer();
    }
    syncMobileNavButton();
  };
  if (typeof media.addEventListener === 'function') {
    media.addEventListener('change', onChange);
  } else if (typeof media.addListener === 'function') {
    media.addListener(onChange);
  }
}

// --- Binary protocol ---
function sendBinary(type, target, payload) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(encodeBinaryFrame(type, target, payload));
}

function handleBinaryMessage(buffer) {
  var parsed = decodeBinaryFrame(buffer);
  var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(parsed.agentName) + '"]');
  if (!el) return;
  if (parsed.msgType === BinaryMsgType.TerminalSnapshot) el.reset();
  if (parsed.msgType === BinaryMsgType.TerminalOutput || parsed.msgType === BinaryMsgType.TerminalSnapshot) {
    el.write(parsed.payload);
  }
}

// --- Terminal management ---
function showTerminal(target) {
  outputWrapEl.querySelectorAll('tmux-adapter-web').forEach(function(el) {
    el.style.display = 'none';
  });

  var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(target) + '"]');
  if (!el) {
    el = document.createElement('tmux-adapter-web');
    el.setAttribute('name', target);
    outputWrapEl.appendChild(el);
  }
  el.style.display = '';
  placeholderEl.style.display = 'none';

  requestAnimationFrame(function() { el.focus(); });
}

function hideAllTerminals() {
  outputWrapEl.querySelectorAll('tmux-adapter-web').forEach(function(el) {
    el.style.display = 'none';
  });
  placeholderEl.style.display = '';
}

// --- WebSocket ---
function connect() {
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  var wsURL = new URL(proto + '//' + adapterHost + '/ws');
  var token = new URLSearchParams(location.search).get('token');
  if (token) wsURL.searchParams.set('token', token);
  ws = new WebSocket(wsURL.toString());
  ws.binaryType = 'arraybuffer';

  ws.onopen = function() {
    statusDot.classList.remove('disconnected');
    statusText.textContent = 'Connected';
    requestTmuxTree();
    startTreeRefresh();

    // Re-subscribe to selected pane on reconnect
    if (selectedTarget) {
      var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(selectedTarget) + '"]');
      if (el) el.reset();
      showTerminal(selectedTarget);
      subscribeOutputWithSizedSnapshot(selectedTarget);
    }
  };

  ws.onclose = function() {
    statusDot.classList.add('disconnected');
    statusText.textContent = 'Disconnected';
    stopTreeRefresh();
    if (treeData.length === 0) startTreeLoading();
    setTimeout(connect, 2000);
  };

  ws.onmessage = function(ev) {
    if (typeof ev.data === 'string') {
      handleJsonMessage(JSON.parse(ev.data));
    } else if (ev.data instanceof ArrayBuffer) {
      handleBinaryMessage(ev.data);
    }
  };
}

function send(obj) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return null;
  obj.id = String(++msgId);
  ws.send(JSON.stringify(obj));
  return obj.id;
}

function requestTmuxTree() {
  send({ type: 'list-tmux-tree' });
}

function startTreeRefresh() {
  stopTreeRefresh();
  treeRefreshInterval = setInterval(function() {
    if (ws && ws.readyState === WebSocket.OPEN) requestTmuxTree();
  }, TreeRefreshMs);
}

function stopTreeRefresh() {
  if (treeRefreshInterval) {
    clearInterval(treeRefreshInterval);
    treeRefreshInterval = null;
  }
}

// --- JSON message handling ---
function handleJsonMessage(msg) {
  switch (msg.type) {
    case 'list-tmux-tree':
      if (msg.tree) {
        treeData = msg.tree;
        // Auto-expand all sessions on first load
        if (expandedNodes.size === 0) {
          treeData.forEach(function(sess) {
            expandedNodes.add('s:' + sess.name);
            if (sess.windows) sess.windows.forEach(function(win) {
              expandedNodes.add('w:' + sess.name + ':' + win.index);
            });
          });
        }
        markTreeLoaded();
        renderTree();
      }
      break;

    case 'subscribe-output':
      break;

    case 'error':
      console.error('ws error:', msg.error || msg);
      break;
  }
}

// --- Tree rendering ---
function renderTree() {
  clearChildren(treeViewEl);

  if (treeLoading) {
    var loading = document.createElement('div');
    loading.className = 'agent-list-state';
    var spinner = document.createElement('span');
    spinner.className = 'spinner';
    loading.appendChild(spinner);
    var text = document.createElement('span');
    text.textContent = 'Loading...';
    loading.appendChild(text);
    treeViewEl.appendChild(loading);
    return;
  }

  if (treeData.length === 0) {
    var empty = document.createElement('div');
    empty.className = 'agent-list-state' + (treeLoadTimedOut ? ' timeout' : '');
    empty.textContent = treeLoadTimedOut ? 'Load timed out' : 'No tmux sessions';
    treeViewEl.appendChild(empty);
    return;
  }

  treeData.forEach(function(sess) {
    treeViewEl.appendChild(buildSessionNode(sess));
  });
}

function buildSessionNode(sess) {
  var nodeId = 's:' + sess.name;
  var isOpen = expandedNodes.has(nodeId);
  var winCount = sess.windows ? sess.windows.length : 0;

  var node = document.createElement('div');
  node.className = 'tree-node tree-session';

  var row = document.createElement('div');
  row.className = 'tree-row';

  var toggle = document.createElement('span');
  toggle.className = 'tree-toggle' + (isOpen ? ' open' : '');
  toggle.textContent = '\u25B6';
  row.appendChild(toggle);

  var icon = document.createElement('span');
  icon.className = 'tree-icon';
  icon.textContent = '\u25A0';
  row.appendChild(icon);

  var label = document.createElement('span');
  label.className = 'tree-label';
  label.textContent = sess.name;
  row.appendChild(label);

  if (sess.attached) {
    var badge = document.createElement('span');
    badge.className = 'tree-badge-attached';
    badge.textContent = 'attached';
    row.appendChild(badge);
  }

  var meta = document.createElement('span');
  meta.className = 'tree-meta';
  meta.textContent = winCount + 'w';
  row.appendChild(meta);

  row.addEventListener('click', function(e) {
    e.stopPropagation();
    if (isOpen) {
      expandedNodes.delete(nodeId);
    } else {
      expandedNodes.add(nodeId);
    }
    renderTree();
  });

  node.appendChild(row);

  if (isOpen && sess.windows) {
    var children = document.createElement('div');
    children.className = 'tree-children';
    sess.windows.forEach(function(win) {
      children.appendChild(buildWindowNode(sess.name, win));
    });
    node.appendChild(children);
  }

  return node;
}

function buildWindowNode(sessName, win) {
  var nodeId = 'w:' + sessName + ':' + win.index;
  var isOpen = expandedNodes.has(nodeId);
  var paneCount = win.panes ? win.panes.length : 0;

  var node = document.createElement('div');
  node.className = 'tree-node tree-window';

  var row = document.createElement('div');
  row.className = 'tree-row';

  var toggle = document.createElement('span');
  toggle.className = 'tree-toggle' + (isOpen ? ' open' : '');
  toggle.textContent = '\u25B6';
  row.appendChild(toggle);

  var icon = document.createElement('span');
  icon.className = 'tree-icon';
  icon.textContent = '\u25AB';
  row.appendChild(icon);

  var label = document.createElement('span');
  label.className = 'tree-label';
  label.textContent = win.index + ': ' + win.name;
  row.appendChild(label);

  if (win.active) {
    var dot = document.createElement('span');
    dot.className = 'tree-badge-active';
    dot.title = 'active window';
    row.appendChild(dot);
  }

  var meta = document.createElement('span');
  meta.className = 'tree-meta';
  meta.textContent = paneCount + 'p';
  row.appendChild(meta);

  row.addEventListener('click', function(e) {
    e.stopPropagation();
    if (isOpen) {
      expandedNodes.delete(nodeId);
    } else {
      expandedNodes.add(nodeId);
    }
    renderTree();
  });

  node.appendChild(row);

  if (isOpen && win.panes) {
    var children = document.createElement('div');
    children.className = 'tree-children';
    win.panes.forEach(function(pane) {
      children.appendChild(buildPaneNode(sessName, win, pane));
    });
    node.appendChild(children);
  }

  return node;
}

function buildPaneNode(sessName, win, pane) {
  var target = pane.target;
  var isSelected = target === selectedTarget;

  var node = document.createElement('div');
  node.className = 'tree-node tree-pane';

  var row = document.createElement('div');
  row.className = 'tree-row' + (isSelected ? ' selected' : '');

  // No toggle for leaf nodes, but add spacing
  var spacer = document.createElement('span');
  spacer.className = 'tree-toggle';
  spacer.textContent = '';
  row.appendChild(spacer);

  var icon = document.createElement('span');
  icon.className = 'tree-icon';
  icon.textContent = '>';
  row.appendChild(icon);

  var label = document.createElement('span');
  label.className = 'tree-label';
  label.textContent = pane.index + ': ' + pane.command;
  row.appendChild(label);

  if (pane.active) {
    var dot = document.createElement('span');
    dot.className = 'tree-badge-active';
    dot.title = 'active pane';
    row.appendChild(dot);
  }

  var meta = document.createElement('span');
  meta.className = 'tree-meta';
  meta.textContent = pane.width + '\u00D7' + pane.height;
  row.appendChild(meta);

  row.addEventListener('click', function(e) {
    e.stopPropagation();
    selectPane(target, sessName, win, pane);
  });

  node.appendChild(row);
  return node;
}

// --- Pane selection ---
function selectPane(target, sessName, win, pane) {
  if (selectedTarget === target) {
    if (isMobileLayout()) closeDrawer();
    return;
  }

  // Unsubscribe from previous
  if (selectedTarget) {
    send({ type: 'unsubscribe-output', agent: selectedTarget });
  }

  selectedTarget = target;

  // Reset terminal for fresh snapshot
  var el = outputWrapEl.querySelector('tmux-adapter-web[name="' + CSS.escape(target) + '"]');
  if (el) el.reset();

  updateHeader(sessName, win, pane);
  renderTree();

  showTerminal(target);
  subscribeOutputWithSizedSnapshot(target);

  if (isMobileLayout()) closeDrawer();
  syncMobileNavButton();
}

function deselectPane() {
  selectedTarget = null;
  hideAllTerminals();
  clearChildren(headerContentEl);
  headerContentEl.textContent = 'Select a pane to view';
  renderTree();
  if (isMobileLayout()) openDrawer();
  syncMobileNavButton();
}

function updateHeader(sessName, win, pane) {
  if (!selectedTarget) return;
  clearChildren(headerContentEl);

  var sessLabel = document.createElement('span');
  sessLabel.className = 'agent-label';
  sessLabel.textContent = sessName;
  headerContentEl.appendChild(sessLabel);

  var sep1 = document.createElement('span');
  sep1.textContent = '\u203A';
  sep1.style.color = '#484f58';
  headerContentEl.appendChild(sep1);

  var winLabel = document.createElement('span');
  winLabel.style.color = '#a371f7';
  winLabel.textContent = win.index + ':' + win.name;
  headerContentEl.appendChild(winLabel);

  var sep2 = document.createElement('span');
  sep2.textContent = '\u203A';
  sep2.style.color = '#484f58';
  headerContentEl.appendChild(sep2);

  var paneLabel = document.createElement('span');
  paneLabel.style.color = '#3fb950';
  paneLabel.textContent = pane.command + ' (' + pane.width + '\u00D7' + pane.height + ')';
  headerContentEl.appendChild(paneLabel);

  syncMobileNavButton();
}

// --- Virtual keyboard viewport adjustment ---
if (window.visualViewport) {
  var containerEl = document.querySelector('.container');
  window.visualViewport.addEventListener('resize', function() {
    containerEl.style.height = window.visualViewport.height + 'px';
  });
  window.visualViewport.addEventListener('scroll', function() {
    window.scrollTo(0, 0);
  });
}

// --- Boot ---
bindMobileLayoutEvents();
startTreeLoading();
connect();
syncMobileNavButton();
if (isMobileLayout() && !selectedTarget) {
  openDrawer();
}
</script>
</body>
</html>
