<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Converter Dashboard</title>
<link rel="stylesheet" href="/shared/styles.css">
<style>
  /* Converter-dashboard-specific styles */
  .badge-attached { background: #1f6feb33; color: #58a6ff; }

  /* Runtime pill colors */
  .badge.badge-runtime { background: #6e768133; color: #8b949e; }
  .badge.runtime-claude  { background: #1f6feb33; color: #58a6ff; }
  .badge.runtime-gemini  { background: #23863633; color: #3fb950; }
  .badge.runtime-codex   { background: #d2992233; color: #d29922; }
  .badge.runtime-cursor  { background: #1b7c8333; color: #39d2e0; }
  .badge.runtime-auggie  { background: #f778ba33; color: #f778ba; }
  .badge.runtime-amp     { background: #da363333; color: #f85149; }
  .badge.runtime-opencode { background: #6e768133; color: #8b949e; }

  /* Filter bar */
  .filter-bar { padding: 8px; border-bottom: 1px solid #30363d; }
  .filter-row { display: flex; align-items: center; gap: 4px; margin-bottom: 4px; }
  .filter-row:last-of-type { margin-bottom: 0; }
  .filter-label { font-size: 10px; color: #8b949e; width: 50px; flex-shrink: 0; text-transform: uppercase; letter-spacing: 0.3px; }
  .filter-input { flex: 1; background: #0d1117; border: 1px solid #30363d; border-radius: 4px; color: #c9d1d9; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 12px; padding: 4px 6px; outline: none; min-width: 0; }
  .filter-input:focus { border-color: #58a6ff; }
  .filter-input.error { border-color: #f85149; }
  .filter-clear { background: none; border: none; color: #8b949e; font-size: 14px; cursor: pointer; padding: 2px 4px; line-height: 1; flex-shrink: 0; }
  .filter-clear:hover { color: #c9d1d9; }
  .filter-error { font-size: 10px; color: #f85149; margin: 2px 0 2px 54px; display: none; }
  .filter-error.visible { display: block; }
  .agent-count { font-size: 11px; color: #8b949e; padding: 4px 0 0 0; }
  .filter-section-label { font-size: 9px; color: #484f58; text-transform: uppercase; letter-spacing: 0.5px; margin: 4px 0 2px 0; }
  .agent-workdir { font-size: 10px; color: #484f58; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  .agent-conv-id {
    font-size: 10px;
    color: #484f58;
    margin-top: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .header-conv-id {
    color: #484f58;
    font-size: 11px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <div class="sidebar-header">
      <button type="button" class="sidebar-close" id="sidebar-close" aria-label="Close drawer">&#xD7;</button>
      <span class="sidebar-title">Agents</span>
    </div>
    <div class="filter-bar" id="filter-bar">
      <div class="filter-section-label">Name</div>
      <div class="filter-row">
        <span class="filter-label">Include</span>
        <input type="text" class="filter-input" id="filter-name-include" placeholder="regex" spellcheck="false" autocomplete="off">
        <button type="button" class="filter-clear" id="filter-name-include-clear" aria-label="Clear">&times;</button>
      </div>
      <div id="filter-name-include-error" class="filter-error"></div>
      <div class="filter-row">
        <span class="filter-label">Exclude</span>
        <input type="text" class="filter-input" id="filter-name-exclude" placeholder="regex" spellcheck="false" autocomplete="off">
        <button type="button" class="filter-clear" id="filter-name-exclude-clear" aria-label="Clear">&times;</button>
      </div>
      <div id="filter-name-exclude-error" class="filter-error"></div>
      <div class="filter-section-label">Path</div>
      <div class="filter-row">
        <span class="filter-label">Include</span>
        <input type="text" class="filter-input" id="filter-path-include" placeholder="regex" spellcheck="false" autocomplete="off">
        <button type="button" class="filter-clear" id="filter-path-include-clear" aria-label="Clear">&times;</button>
      </div>
      <div id="filter-path-include-error" class="filter-error"></div>
      <div class="filter-row">
        <span class="filter-label">Exclude</span>
        <input type="text" class="filter-input" id="filter-path-exclude" placeholder="regex" spellcheck="false" autocomplete="off">
        <button type="button" class="filter-clear" id="filter-path-exclude-clear" aria-label="Clear">&times;</button>
      </div>
      <div id="filter-path-exclude-error" class="filter-error"></div>
      <div class="agent-count" id="agent-count"></div>
    </div>
    <div class="agent-list" id="agent-list">
      <div class="agent-list-state"><span class="spinner"></span><span>Loading agents...</span></div>
    </div>
  </div>

  <div class="main">
    <div class="main-header" id="main-header">
      <button type="button" class="mobile-nav-btn" id="mobile-nav-btn" aria-label="Open drawer">&#x2630;</button>
      <div class="header-content" id="header-content">Select an agent to view conversation</div>
      <div class="connection-status" id="connection-status">
        <span class="dot disconnected" id="status-dot"></span>
        <span id="status-text">Connecting...</span>
      </div>
    </div>
    <tmux-converter-web id="converter-view" style="display:none"></tmux-converter-web>
    <div class="placeholder" id="placeholder">Select an agent from the sidebar</div>
  </div>
</div>
<div class="drawer-backdrop" id="drawer-backdrop"></div>

<script type="module">
import { clearChildren, createBadge, isMobileLayout, openDrawer, closeDrawer, bindMobileLayoutEvents } from '/shared/utils.js';
import { encodeBinaryFrame, BinaryMsgType } from '/tmux-converter-web/index.js';

var converterHost = new URLSearchParams(location.search).get('converter') || location.host || 'localhost:8081';

// --- State ---
var agents = new Map();
var selectedAgent = null;
var currentConvId = null;
var currentSubId = null;
var ws = null;
var msgId = 0;
var handshakeDone = false;
var textEncoder = new TextEncoder();
var agentsLoading = true;
var agentsLoadTimedOut = false;
var agentsLoadTimer = null;
var AgentsLoadTimeoutMs = 7000;
var totalAgents = null;
var filterDebounceTimer = null;
var pendingChunks = null; // {events: [], total: int} when receiving chunked snapshot
var FilterStorageKey = 'tmux-converter-filter';

// --- DOM refs ---
var agentListEl = document.getElementById('agent-list');
var headerContentEl = document.getElementById('header-content');
var placeholderEl = document.getElementById('placeholder');
var statusDot = document.getElementById('status-dot');
var statusText = document.getElementById('status-text');
var mobileNavBtn = document.getElementById('mobile-nav-btn');
var sidebarCloseBtn = document.getElementById('sidebar-close');
var drawerBackdropEl = document.getElementById('drawer-backdrop');
var converterEl = document.getElementById('converter-view');
var filterNameIncludeEl = document.getElementById('filter-name-include');
var filterNameExcludeEl = document.getElementById('filter-name-exclude');
var filterNameIncludeClearEl = document.getElementById('filter-name-include-clear');
var filterNameExcludeClearEl = document.getElementById('filter-name-exclude-clear');
var filterNameIncludeErrorEl = document.getElementById('filter-name-include-error');
var filterNameExcludeErrorEl = document.getElementById('filter-name-exclude-error');
var filterPathIncludeEl = document.getElementById('filter-path-include');
var filterPathExcludeEl = document.getElementById('filter-path-exclude');
var filterPathIncludeClearEl = document.getElementById('filter-path-include-clear');
var filterPathExcludeClearEl = document.getElementById('filter-path-exclude-clear');
var filterPathIncludeErrorEl = document.getElementById('filter-path-include-error');
var filterPathExcludeErrorEl = document.getElementById('filter-path-exclude-error');
var agentCountEl = document.getElementById('agent-count');

// --- Agent loading state machine ---
function clearAgentsLoadTimer() {
  if (!agentsLoadTimer) return;
  clearTimeout(agentsLoadTimer);
  agentsLoadTimer = null;
}

function startAgentsLoading() {
  agentsLoading = true;
  agentsLoadTimedOut = false;
  clearAgentsLoadTimer();
  agentsLoadTimer = setTimeout(function() {
    if (!agentsLoading) return;
    agentsLoading = false;
    agentsLoadTimedOut = true;
    renderAgentList();
  }, AgentsLoadTimeoutMs);
  renderAgentList();
}

function markAgentsLoaded() {
  agentsLoading = false;
  agentsLoadTimedOut = false;
  clearAgentsLoadTimer();
}

// --- Mobile drawer ---
bindMobileLayoutEvents(mobileNavBtn, sidebarCloseBtn, drawerBackdropEl);

// --- Component events ---
converterEl.addEventListener('converter-send', async function(e) {
  var detail = e.detail;
  // Send files first as binary frames
  for (var i = 0; i < detail.files.length; i++) {
    var file = detail.files[i];
    var fileBytes = new Uint8Array(await file.arrayBuffer());
    var nameBytes = textEncoder.encode(file.name || 'attachment.bin');
    var mimeBytes = textEncoder.encode(file.type || 'application/octet-stream');
    var payload = new Uint8Array(nameBytes.length + 1 + mimeBytes.length + 1 + fileBytes.length);
    payload.set(nameBytes, 0);
    payload[nameBytes.length] = 0;
    payload.set(mimeBytes, nameBytes.length + 1);
    payload[nameBytes.length + 1 + mimeBytes.length] = 0;
    payload.set(fileBytes, nameBytes.length + 1 + mimeBytes.length + 1);
    ws.send(encodeBinaryFrame(BinaryMsgType.FileUpload, selectedAgent, payload));
  }
  // Then send prompt
  if (detail.prompt) {
    send({ type: 'send-prompt', agent: detail.name, prompt: detail.prompt });
  }
});

converterEl.addEventListener('filter-change', function(e) {
  if (selectedAgent && handshakeDone) {
    send({ type: 'follow-agent', agent: selectedAgent, filter: e.detail });
  }
});

// --- Filter logic ---
function getFilterValues() {
  return {
    nameInclude: filterNameIncludeEl.value,
    nameExclude: filterNameExcludeEl.value,
    pathInclude: filterPathIncludeEl.value,
    pathExclude: filterPathExcludeEl.value
  };
}

function loadFilter() {
  try {
    var stored = localStorage.getItem(FilterStorageKey);
    if (!stored) return;
    var f = JSON.parse(stored);
    if (f.nameInclude) filterNameIncludeEl.value = f.nameInclude;
    if (f.nameExclude) filterNameExcludeEl.value = f.nameExclude;
    if (f.pathInclude) filterPathIncludeEl.value = f.pathInclude;
    if (f.pathExclude) filterPathExcludeEl.value = f.pathExclude;
    // Migrate old format
    if (f.include && !f.nameInclude) filterNameIncludeEl.value = f.include;
    if (f.exclude && !f.nameExclude) filterNameExcludeEl.value = f.exclude;
  } catch (e) { console.warn('localStorage error:', e); }
}

function saveFilter() {
  try {
    localStorage.setItem(FilterStorageKey, JSON.stringify(getFilterValues()));
  } catch (e) { console.warn('localStorage error:', e); }
}

function clearFilterErrors() {
  [filterNameIncludeErrorEl, filterNameExcludeErrorEl, filterPathIncludeErrorEl, filterPathExcludeErrorEl].forEach(function(el) {
    el.textContent = '';
    el.classList.remove('visible');
  });
  [filterNameIncludeEl, filterNameExcludeEl, filterPathIncludeEl, filterPathExcludeEl].forEach(function(el) {
    el.classList.remove('error');
  });
}

function showFilterError(errText) {
  var pairs = [
    { keyword: 'session include', errEl: filterNameIncludeErrorEl, inputEl: filterNameIncludeEl },
    { keyword: 'session exclude', errEl: filterNameExcludeErrorEl, inputEl: filterNameExcludeEl },
    { keyword: 'path include', errEl: filterPathIncludeErrorEl, inputEl: filterPathIncludeEl },
    { keyword: 'path exclude', errEl: filterPathExcludeErrorEl, inputEl: filterPathExcludeEl }
  ];
  for (var i = 0; i < pairs.length; i++) {
    if (errText.indexOf(pairs[i].keyword) !== -1) {
      pairs[i].errEl.textContent = errText;
      pairs[i].errEl.classList.add('visible');
      pairs[i].inputEl.classList.add('error');
      return;
    }
  }
}

function sendSubscribeAgents() {
  var f = getFilterValues();
  var msg = { type: 'subscribe-agents' };
  if (f.nameInclude) msg.includeSessionFilter = f.nameInclude;
  if (f.nameExclude) msg.excludeSessionFilter = f.nameExclude;
  if (f.pathInclude) msg.includePathFilter = f.pathInclude;
  if (f.pathExclude) msg.excludePathFilter = f.pathExclude;
  clearFilterErrors();
  send(msg);
}

function onFilterInput() {
  clearTimeout(filterDebounceTimer);
  filterDebounceTimer = setTimeout(function() {
    saveFilter();
    sendSubscribeAgents();
  }, 300);
}

function updateAgentCount() {
  var shown = agents.size;
  if (totalAgents !== null && totalAgents !== shown) {
    agentCountEl.textContent = shown + ' of ' + totalAgents + ' agents';
  } else {
    agentCountEl.textContent = shown + ' agents';
  }
}

loadFilter();
[filterNameIncludeEl, filterNameExcludeEl, filterPathIncludeEl, filterPathExcludeEl].forEach(function(el) {
  el.addEventListener('input', onFilterInput);
});
filterNameIncludeClearEl.addEventListener('click', function() { filterNameIncludeEl.value = ''; onFilterInput(); });
filterNameExcludeClearEl.addEventListener('click', function() { filterNameExcludeEl.value = ''; onFilterInput(); });
filterPathIncludeClearEl.addEventListener('click', function() { filterPathIncludeEl.value = ''; onFilterInput(); });
filterPathExcludeClearEl.addEventListener('click', function() { filterPathExcludeEl.value = ''; onFilterInput(); });

// --- WebSocket ---
function connect() {
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  var wsURL = proto + '//' + converterHost + '/ws';
  ws = new WebSocket(wsURL);
  handshakeDone = false;

  ws.onopen = function() {
    statusDot.classList.remove('disconnected');
    statusText.textContent = 'Connected';
    if (agents.size === 0) {
      startAgentsLoading();
    }
    send({ id: 'hello', type: 'hello', protocol: 'tmux-converter.v1' });
  };

  ws.onmessage = function(ev) {
    handleMessage(JSON.parse(ev.data));
  };

  ws.onclose = function() {
    statusDot.classList.add('disconnected');
    statusText.textContent = 'Disconnected';
    handshakeDone = false;
    if (agents.size === 0) {
      startAgentsLoading();
    }
    setTimeout(connect, 2000);
  };

  ws.onerror = function() {};
}

function send(obj) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  if (!obj.id) obj.id = 'req' + (++msgId);
  ws.send(JSON.stringify(obj));
}

// --- Message handling ---
function handleMessage(msg) {
  switch (msg.type) {
    case 'hello':
      if (msg.ok) {
        handshakeDone = true;
        sendSubscribeAgents();
        if (selectedAgent) {
          send({ type: 'follow-agent', agent: selectedAgent, filter: converterEl.getFilters() });
        }
      }
      break;

    case 'list-agents':
    case 'subscribe-agents':
      if (msg.type === 'subscribe-agents' && msg.ok === false) {
        showFilterError(msg.error || 'Invalid filter');
        break;
      }
      agents.clear();
      if (msg.agents) msg.agents.forEach(function(a) { agents.set(a.name, a); });
      if (msg.totalAgents !== undefined) totalAgents = msg.totalAgents;
      markAgentsLoaded();
      renderAgentList();
      updateAgentCount();
      break;

    case 'agent-added':
      if (msg.agent) agents.set(msg.agent.name, msg.agent);
      if (msg.totalAgents !== undefined) totalAgents = msg.totalAgents;
      renderAgentList();
      updateAgentCount();
      break;

    case 'agent-removed':
      var removedName = msg.name || (msg.agent && msg.agent.name);
      if (removedName) {
        agents.delete(removedName);
        if (selectedAgent === removedName) deselectAgent();
      }
      if (msg.totalAgents !== undefined) totalAgents = msg.totalAgents;
      renderAgentList();
      updateAgentCount();
      break;

    case 'agent-updated':
      if (msg.agent) agents.set(msg.agent.name, msg.agent);
      renderAgentList();
      updateAgentCount();
      break;

    case 'agents-count':
      if (msg.totalAgents !== undefined) totalAgents = msg.totalAgents;
      updateAgentCount();
      break;

    case 'follow-agent':
      if (msg.ok) {
        currentSubId = msg.subscriptionId;
        if (msg.conversationId) {
          currentConvId = msg.conversationId;
          pendingChunks = { events: [] };
          converterEl.showWaiting('Loading conversation...');
        } else if (msg.conversationSupported === false) {
          pendingChunks = null;
          converterEl.showWaiting('Conversation streaming is not supported for this runtime yet.');
        } else {
          pendingChunks = null;
          converterEl.showWaiting('No conversation yet \u2014 waiting for activity...');
        }
        updateHeader();
      } else {
        converterEl.showError('Error: ' + (msg.error || 'unknown'));
      }
      break;

    case 'conversation-snapshot':
      currentConvId = msg.conversationId;
      currentSubId = msg.subscriptionId;
      pendingChunks = { events: [] };
      converterEl.showWaiting('Loading conversation...');
      updateHeader();
      break;

    case 'conversation-snapshot-chunk':
      if (msg.subscriptionId === currentSubId && msg.events) {
        if (!pendingChunks) pendingChunks = { events: [] };
        for (var i = 0; i < msg.events.length; i++) pendingChunks.events.push(msg.events[i]);
        if (msg.progress) converterEl.showProgress(msg.progress.loaded, msg.progress.total || 0);
      }
      break;

    case 'conversation-snapshot-end':
      if (pendingChunks && msg.subscriptionId === currentSubId) {
        converterEl.setEvents(pendingChunks.events, true);
        pendingChunks = null;
      }
      break;

    case 'conversation-event':
      if (msg.event && msg.subscriptionId === currentSubId) {
        if (pendingChunks) {
          // Events arriving during chunk download â€” accumulate
          pendingChunks.events.push(msg.event);
        } else {
          converterEl.appendEvent(msg.event);
        }
      }
      break;

    case 'conversation-switched':
      pendingChunks = null;
      currentConvId = msg.to;
      converterEl.addSwitchNotice(msg.from, msg.to);
      break;

    case 'send-prompt':
      if (!msg.ok) console.error('send-prompt error:', msg.error);
      break;

    case 'error':
      console.error('ws error:', msg.error);
      break;
  }
}

// --- Agent list rendering ---
function renderAgentList() {
  clearChildren(agentListEl);

  if (agentsLoading) {
    var loading = document.createElement('div');
    loading.className = 'agent-list-state';
    var spinner = document.createElement('span');
    spinner.className = 'spinner';
    loading.appendChild(spinner);
    var loadingText = document.createElement('span');
    loadingText.textContent = 'Loading agents...';
    loading.appendChild(loadingText);
    agentListEl.appendChild(loading);
    return;
  }

  if (agents.size === 0) {
    var empty = document.createElement('div');
    empty.className = 'agent-list-state' + (agentsLoadTimedOut ? ' timeout' : '');
    empty.textContent = agentsLoadTimedOut ? 'Agent list load timed out' : 'No agents running';
    agentListEl.appendChild(empty);
    return;
  }

  var sorted = Array.from(agents.values()).sort(function(a, b) {
    return a.name.localeCompare(b.name);
  });

  sorted.forEach(function(agent) {
    var card = document.createElement('div');
    card.className = 'agent-card' + (agent.name === selectedAgent ? ' selected' : '');
    card.addEventListener('click', function() { selectAgent(agent.name); });

    var nameRow = document.createElement('div');
    nameRow.className = 'agent-name';
    var nameSpan = document.createElement('span');
    nameSpan.textContent = agent.name;
    nameRow.appendChild(nameSpan);
    card.appendChild(nameRow);

    var metaRow = document.createElement('div');
    metaRow.className = 'agent-meta';
    metaRow.appendChild(createBadge(agent.runtime || '?', 'badge badge-runtime runtime-' + (agent.runtime || 'unknown')));
    if (agent.attached) {
      metaRow.appendChild(createBadge('attached', 'badge badge-attached'));
    }
    card.appendChild(metaRow);

    if (agent.workDir) {
      var wdRow = document.createElement('div');
      wdRow.className = 'agent-workdir';
      wdRow.textContent = agent.workDir;
      wdRow.title = agent.workDir;
      card.appendChild(wdRow);
    }

    if (agent.conversationId) {
      var convRow = document.createElement('div');
      convRow.className = 'agent-conv-id';
      convRow.textContent = agent.conversationId;
      card.appendChild(convRow);
    }

    agentListEl.appendChild(card);
  });
}

// --- Agent selection ---
function selectAgent(name) {
  if (selectedAgent === name) {
    if (isMobileLayout()) closeDrawer();
    return;
  }

  // Unfollow previous
  if (selectedAgent) {
    send({ type: 'unsubscribe-agent', agent: selectedAgent });
  }

  selectedAgent = name;
  currentConvId = null;
  currentSubId = null;
  pendingChunks = null;

  converterEl.setAttribute('name', name);
  converterEl.style.display = '';
  converterEl.showFilters();
  converterEl.showInputArea();
  placeholderEl.style.display = 'none';
  converterEl.clear();
  converterEl.showWaiting('Loading conversation...');

  renderAgentList();
  updateHeader();

  send({ type: 'follow-agent', agent: name, filter: converterEl.getFilters() });

  if (isMobileLayout()) closeDrawer();
}

function deselectAgent() {
  if (selectedAgent) {
    send({ type: 'unsubscribe-agent', agent: selectedAgent });
  }
  selectedAgent = null;
  currentConvId = null;
  currentSubId = null;

  clearChildren(headerContentEl);
  headerContentEl.textContent = 'Select an agent to view conversation';

  converterEl.style.display = 'none';
  converterEl.hideFilters();
  converterEl.hideInputArea();
  converterEl.clearAttachments();
  placeholderEl.style.display = '';

  renderAgentList();
  if (isMobileLayout()) openDrawer();
}

function updateHeader() {
  if (!selectedAgent) return;
  var agent = agents.get(selectedAgent);

  clearChildren(headerContentEl);

  var label = document.createElement('span');
  label.className = 'agent-label';
  label.textContent = selectedAgent;
  headerContentEl.appendChild(label);

  if (agent) {
    headerContentEl.appendChild(createBadge(agent.runtime || '?', 'badge badge-runtime runtime-' + (agent.runtime || 'unknown')));
  }

  if (currentConvId) {
    var convSpan = document.createElement('span');
    convSpan.className = 'header-conv-id';
    convSpan.textContent = currentConvId;
    headerContentEl.appendChild(convSpan);
  }
}

// --- Boot ---
startAgentsLoading();
connect();
if (isMobileLayout() && !selectedAgent) openDrawer();
</script>
</body>
</html>
